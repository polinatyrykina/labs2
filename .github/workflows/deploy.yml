name: Deploy site on release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine release name
        run: echo "RELEASE_NAME=${GITHUB_REF_NAME}" >> $GITHUB_ENV

      - name: Create root redirect with CURRENT release
        run: |
          # Создаем корневой index.html который перенаправляет на ТЕКУЩИЙ релиз
          cat > root_index.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
              <meta http-equiv="refresh" content="0; url=./${RELEASE_NAME}/">
              <title>Redirecting to ${RELEASE_NAME}</title>
          </head>
          <body>
              <p>Redirecting to latest version ${RELEASE_NAME}... <a href="./${RELEASE_NAME}/">Click here</a></p>
          </body>
          </html>
          EOF

        
      - name: Prepare site files
        run: |
          mkdir -p _site
          cp -R index.html ru en _site/
          echo "Содержимое _site:"
          ls -R _site

      - name: Deploy to GitHub Pages 
        uses: peaceiris/actions-gh-pages@v4 
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          destination_dir: ${{ env.RELEASE_NAME }}
          keep_files: true
          
      - name: Deploy root redirect to main site
        uses: peaceiris/actions-gh-pages@v4 
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          keep_files: true
          
        