name: Release Pipeline

on:
  release:
    types: [published, created]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install Flask bandit
    
    - name: Test application
      run: |
        echo "Проверяю приложение..."
        if [ -f "app.py" ]; then
          python -c "from app import app; print('✓ Приложение работает')"
        else
          echo "✗ app.py не найден"
        fi
    
    - name: Security check
      run: |
        bandit -r . -q || echo "Проверка безопасности завершена"

  changelog:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Make script executable
      run: chmod +x generate_changelog.sh
    
    - name: Generate changelog
      env:
        GITHUB_REF_NAME: ${{ github.event.release.tag_name }}
      run: |
        echo "Текущий релиз: $GITHUB_REF_NAME"
        ./generate_changelog.sh
    
    - name: View changelog
      run: |
        echo "=== Созданный CHANGELOG ==="
        head -20 CHANGELOG.md
    
    - name: Upload changelog to release
      uses: softprops/action-gh-release@v1
      with:
        files: CHANGELOG.md
        tag_name: ${{ github.event.release.tag_name }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy:
    runs-on: ubuntu-latest
    needs: changelog
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    # - name: Deploy to GitHub Pages
    #   uses: peaceiris/actions-gh-pages@v4
    #   with:
    #     github_token: ${{ secrets.GITHUB_TOKEN }}
    #     publish_dir: ./
    #     destination_dir: ${{ github.event.release.tag_name }}
    #     keep_files: true
